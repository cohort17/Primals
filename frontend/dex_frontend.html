<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primals Decentralized Exchange (DEX)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.ethers.io/5.7.2/ethers.umd.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4B4B4B;
        }
        .card {
            background-color: #FFFFFF;
            border: 1px solid #F0EAE1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 1.5rem;
        }
        .btn-primary {
            background-color: #A08C7D;
            color: #FFFFFF;
            transition: background-color 0.3s, transform 0.2s;
            border-radius: 0.75rem;
        }
        .btn-primary:hover {
            background-color: #8A7667;
            transform: translateY(-2px);
        }
        .input-field {
            border: 1px solid #E5DED6;
            background-color: #FFFCF9;
        }
    </style>
</head>
<body class="antialiased p-4 sm:p-8 lg:p-12">
    <div class="container mx-auto max-w-2xl">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-[#A08C7D]">Primals DEX</h1>
            <p class="text-md text-gray-500 mt-2">Swap tokens and provide liquidity in a decentralized way.</p>
        </div>

        <!-- Wallet Connection Status -->
        <div class="card p-6 sm:p-8 mb-6 text-center">
            <h2 class="text-xl font-semibold mb-2">Wallet Connection</h2>
            <div id="wallet-status" class="text-sm text-gray-600 mb-4">Not connected.</div>
            <button id="connect-wallet-btn" class="btn-primary py-2 px-6">Connect Wallet</button>
        </div>

        <!-- DEX Pool Info -->
        <div class="card p-6 sm:p-8 mb-6 text-center">
            <h2 class="text-xl font-semibold mb-2">Current Pool Reserves</h2>
            <p id="pool-reserves" class="text-lg font-bold text-gray-700">Loading...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Add/Remove Liquidity Card -->
            <div class="card p-6 sm:p-8 space-y-4">
                <h3 class="text-xl font-semibold">Provide Liquidity</h3>
                <div>
                    <label for="liquidity-amount-a" class="block text-sm font-medium text-gray-700">Token A Amount (e.g., Minima)</label>
                    <input type="number" id="liquidity-amount-a" class="mt-1 block w-full rounded-lg input-field p-3" placeholder="0.0" required>
                </div>
                <div>
                    <label for="liquidity-amount-b" class="block text-sm font-medium text-gray-700">Token B Amount (e.g., Your Token)</label>
                    <input type="number" id="liquidity-amount-b" class="mt-1 block w-full rounded-lg input-field p-3" placeholder="0.0" required>
                </div>
                <button id="add-liquidity-btn" class="w-full btn-primary py-3 font-semibold text-lg">Add Liquidity</button>
            </div>

            <!-- Token Swap Card -->
            <div class="card p-6 sm:p-8 space-y-4">
                <h3 class="text-xl font-semibold">Swap Tokens</h3>
                <div>
                    <label for="swap-amount-in" class="block text-sm font-medium text-gray-700">Amount to Swap</label>
                    <input type="number" id="swap-amount-in" class="mt-1 block w-full rounded-lg input-field p-3" placeholder="0.0" required>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    Expected output: <span id="swap-output-display" class="font-bold">0</span>
                </div>
                <div>
                    <label for="swap-from-token" class="block text-sm font-medium text-gray-700">From Token</label>
                    <input type="text" id="swap-from-token" class="mt-1 block w-full rounded-lg input-field p-3" placeholder="Paste Token A address" required>
                </div>
                <div>
                    <label for="swap-to-token" class="block text-sm font-medium text-gray-700">To Token</label>
                    <input type="text" id="swap-to-token" class="mt-1 block w-full rounded-lg input-field p-3" placeholder="Paste Token B address" required>
                </div>
                <button id="swap-btn" class="w-full btn-primary py-3 font-semibold text-lg">Swap Tokens</button>
            </div>
        </div>

        <div id="status-message" class="mt-8 text-center text-gray-600 font-medium">
            Ready to interact with the DEX.
        </div>
    </div>

    <script>
        // --- Web3 Configuration & Globals ---
        // Ensure this script block is after the ethers script tag with "defer".
        let provider, signer, connectedAccount, contract, reservesA, reservesB;
        
        // --- Contract Information ---
        const contractAddress = "0x0000000000000000000000000000000000000000"; 
        const contractABI = [
            "function addLiquidity(uint _amountA, uint _amountB)",
            "function swapTokens(address _fromToken, address _toToken, uint _amountIn)",
            "function removeLiquidity(uint _liquidityAmount)",
            "function getReserves() view returns (uint, uint)"
        ];
        
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        
        // --- UI Elements ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const walletStatus = document.getElementById('wallet-status');
        const addLiquidityBtn = document.getElementById('add-liquidity-btn');
        const swapBtn = document.getElementById('swap-btn');
        const statusMessage = document.getElementById('status-message');
        const poolReservesDisplay = document.getElementById('pool-reserves');
        const swapAmountIn = document.getElementById('swap-amount-in');
        const swapOutputDisplay = document.getElementById('swap-output-display');

        // --- Helper Functions ---
        const displayStatus = (message) => {
            statusMessage.textContent = message;
        };

        const checkWeb3 = () => {
            if (typeof window.ethereum === 'undefined') {
                walletStatus.textContent = "Web3 not detected. Please install MetaMask or another wallet.";
                connectWalletBtn.disabled = true;
            } else {
                walletStatus.textContent = "Web3 detected. Click to connect.";
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                // Start fetching reserves periodically
                setInterval(fetchReserves, 5000); 
            }
        };

        const connectWallet = async () => {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                connectedAccount = accounts[0];
                walletStatus.textContent = `Connected: ${connectedAccount.substring(0, 6)}...${connectedAccount.substring(38)}`;
                connectWalletBtn.disabled = true;
                displayStatus("Wallet connected successfully!");
            } catch (error) {
                console.error("User rejected wallet connection:", error);
                displayStatus("Wallet connection failed.");
            }
        };

        const fetchReserves = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/dex/reserves?token_a=minima&token_b=custom-token`);
                if (response.ok) {
                    const data = await response.json();
                    reservesA = data.reserves.reserve_a;
                    reservesB = data.reserves.reserve_b;
                    poolReservesDisplay.textContent = `Token A: ${reservesA} | Token B: ${reservesB}`;
                } else {
                    poolReservesDisplay.textContent = "Reserves not found. Add liquidity to initialize.";
                }
            } catch (error) {
                console.error("Error fetching reserves:", error);
                poolReservesDisplay.textContent = "Failed to fetch reserves. Is the backend running?";
            }
        };

        const calculateSwapOutput = () => {
            const amountIn = parseFloat(swapAmountIn.value);
            if (isNaN(amountIn) || amountIn <= 0 || !reservesA || !reservesB) {
                swapOutputDisplay.textContent = "0";
                return;
            }
            
            // Simple constant product formula: x * y = k
            // Output = (reserveB * amountIn) / (reserveA + amountIn)
            const numerator = reservesB * amountIn;
            const denominator = reservesA + amountIn;
            const output = numerator / denominator;
            
            swapOutputDisplay.textContent = output.toFixed(4);
        };

        const addLiquidity = async () => {
            if (!connectedAccount) {
                displayStatus("Please connect your wallet first.");
                return;
            }
            const amountA = document.getElementById('liquidity-amount-a').value;
            const amountB = document.getElementById('liquidity-amount-b').value;
            if (amountA <= 0 || amountB <= 0) {
                displayStatus("Please enter valid amounts.");
                return;
            }
            displayStatus("Waiting for transaction confirmation...");
            try {
                const tx = await contract.addLiquidity(ethers.utils.parseEther(amountA), ethers.utils.parseEther(amountB));
                const receipt = await tx.wait();
                displayStatus(`Liquidity added! Transaction Hash: ${receipt.transactionHash}`);
            } catch (error) {
                console.error("Error adding liquidity:", error);
                displayStatus(`Error: ${error.message || "Failed to add liquidity."}`);
            }
        };

        const swapTokens = async () => {
            if (!connectedAccount) {
                displayStatus("Please connect your wallet first.");
                return;
            }
            const amountIn = document.getElementById('swap-amount-in').value;
            const fromToken = document.getElementById('swap-from-token').value;
            const toToken = document.getElementById('swap-to-token').value;
            if (amountIn <= 0 || fromToken.length < 42 || toToken.length < 42) {
                displayStatus("Please enter valid token amounts and addresses.");
                return;
            }
            displayStatus("Waiting for transaction confirmation...");
            try {
                const tx = await contract.swapTokens(fromToken, toToken, ethers.utils.parseEther(amountIn));
                const receipt = await tx.wait();
                displayStatus(`Tokens swapped! Transaction Hash: ${receipt.transactionHash}`);
            } catch (error) {
                console.error("Error swapping tokens:", error);
                displayStatus(`Error: ${error.message || "Failed to swap tokens."}`);
            }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', checkWeb3);
        connectWalletBtn.addEventListener('click', connectWallet);
        addLiquidityBtn.addEventListener('click', addLiquidity);
        swapBtn.addEventListener('click', swapTokens);
        swapAmountIn.addEventListener('input', calculateSwapOutput);

    </script>
</body>
    </html>
    
